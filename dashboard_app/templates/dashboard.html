{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
  {# Data containers for our charts #}
  <div id="total-stats-data" data-stats="{{ total_stats_json }}"></div>
  <div id="trend-data" data-trend="{{ trend_data_json }}"></div>

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Dashboard</h1>
    <a href="{{ url_for('manual_enroll') }}" class="btn btn-primary">Manually Enroll Users</a>
  </div>

  <!-- CHARTS SECTION -->
  <div class="content-card mb-4">
    <h4 class="mb-3">Overall Phishing Funnel</h4>
    <div class="row text-center">
      <div class="col-lg-3 col-md-6 mb-3"><canvas id="sentChart" height="200"></canvas></div>
      <div class="col-lg-3 col-md-6 mb-3"><canvas id="openedChart" height="200"></canvas></div>
      <div class="col-lg-3 col-md-6 mb-3"><canvas id="clickedChart" height="200"></canvas></div>
      <div class="col-lg-3 col-md-6 mb-3"><canvas id="submittedChart" height="200"></canvas></div>
    </div>
  </div>

  <div class="content-card mb-4">
    <h4 class="mb-3">Campaign Fail Rate Trend (Last 10)</h4>
    <canvas id="trendChart"></canvas>
  </div>
  
  <div class="content-card mb-4">
    <h4>GoPhish Campaigns</h4>
    <table class="table table-striped table-hover">
      <thead class="table">
        <tr>
          <th>ID</th><th>Campaign Name</th><th>Status</th><th>Created Date</th><th>Fail Rate</th><th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for campaign in campaigns %}
        <tr>
          <td>{{ campaign.id }}</td><td>{{ campaign.name }}</td><td><span class="badge bg-secondary">{{ campaign.status }}</span></td><td>{{ campaign.created_date.split('T')[0] }}</td><td><span class="badge bg-danger">{{ campaign.fail_rate }}</span></td>
          <td><a href="{{ url_for('campaign_details', campaign_id=campaign.id) }}" class="btn btn-sm btn-outline-primary">View Results</a></td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- START OF THE FIX ---

      // 1. Store chart instances so we can destroy them later
      let activeCharts = [];

      // 2. Wrap all chart drawing logic in a single, reusable function
      const renderCharts = () => {
        // First, destroy any old charts to prevent flickering and memory leaks
        activeCharts.forEach(chart => chart.destroy());
        activeCharts = [];

        if (typeof Chart === 'undefined') {
          console.error('Chart.js failed to load. The charts cannot be rendered.');
          return;
        }
        
        const statsElement = document.getElementById('total-stats-data');
        const trendElement = document.getElementById('trend-data');

        let totalStats = null;
        let trendData = null;

        try {
          totalStats = JSON.parse(statsElement.dataset.stats);
          trendData = JSON.parse(trendElement.dataset.trend);
        } catch (e) {
          console.error("Failed to parse chart data from HTML:", e);
          return; 
        }
        
        const isDarkMode = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const textColor = isDarkMode ? '#cdd9e5' : '#212529';
        const gridColor = isDarkMode ? '#444c56' : '#dee2e6';
        const donutBorderColor = isDarkMode ? '#22272e' : '#ffffff';

        const createDonutChart = (ctxId, label, value, total, color) => {
          const ctx = document.getElementById(ctxId);
          if (!ctx) return;
          const chart = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: [label, 'Remaining'],
              datasets: [{
                data: [value, Math.max(0, total - value)],
                backgroundColor: [color, '#6c757d'],
                borderColor: donutBorderColor,
                borderWidth: 2
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              cutout: '70%',
              plugins: {
                legend: { display: false },
                title: {
                  display: true,
                  text: `${label}: ${value}`,
                  color: textColor,
                  font: { size: 14 }
                }
              }
            }
          });
          activeCharts.push(chart);
        };
        
        if (totalStats && totalStats.sent > 0) {
          createDonutChart('sentChart', 'Sent', totalStats.sent, totalStats.sent, '#00a8e8');
          createDonutChart('openedChart', 'Opened', totalStats.opened, totalStats.sent, '#ffc107');
          createDonutChart('clickedChart', 'Clicked', totalStats.clicked, totalStats.sent, '#fd7e14');
          createDonutChart('submittedChart', 'Submitted', totalStats.submitted, totalStats.sent, '#dc3545');
        }

        const trendChartCtx = document.getElementById('trendChart');
        if (trendChartCtx) {
          const chart = new Chart(trendChartCtx, {
            type: 'line',
            data: {
              labels: trendData.labels,
              datasets: [{
                label: 'Fail Rate (%)',
                data: trendData.fail_rates,
                fill: true,
                borderColor: '#00a8e8',
                backgroundColor: 'rgba(0, 168, 232, 0.2)',
                tension: 0.3
              }]
            },
            options: {
              scales: {
                y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } },
                x: { ticks: { color: textColor }, grid: { color: gridColor } }
              },
              plugins: { legend: { labels: { color: textColor } } }
            }
          });
          activeCharts.push(chart);
        }
      };

      // 3. Find the theme toggle button from base.html
      const themeToggleBtn = document.getElementById('theme-toggle');
      if (themeToggleBtn) {
        // 4. Add a click listener that re-renders the charts
        themeToggleBtn.addEventListener('click', () => {
          // Use a tiny timeout to ensure the theme attribute is updated before we redraw
          setTimeout(renderCharts, 50); 
        });
      }

      // 5. Render the charts on initial page load
      renderCharts();

      // --- END OF THE FIX ---
    });
  </script>
{% endblock %}